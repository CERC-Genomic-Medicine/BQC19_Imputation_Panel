# Ancestry Estimation Pipeline

This repository contains a Nextflow pipeline for inferring the genetic ancestry of samples using reference PCA space generated by the HDGP+1KG dataset, along with the TRACE algorithm, random forest, and k-nearest neighbour classifiers.

## Pipeline Steps

1. **Generate Reference PCA Space:** This step generates the reference PCA space using the HDGP+1KG dataset. The default value of K is set to 20.

2. **Project Study Samples:** In this step, the pipeline projects the study samples onto the reference PCA space to assess the study principal components (PCs).

3. **Train Classification Models:** Using the reference PCs and reference ancestry labels, the pipeline trains a random forest classification model and a k-nearest neighbour classification model.

4. **Infer Genetic Ancestry Labels:** This step applies the trained classifier to infer the genetic ancestry labels of the study samples.

## Input Data

The pipeline requires input data in vcf format for both reference and study sets, as well as vcf index files. 

## Output

The pipeline generates the following outputs:

- **Reference PCs:** The reference principal components generated from the HDGP+1KG dataset.
- **Study PCs:** The principal components of the study samples projected onto the reference PCA space.
- **Study Ancestry Labels:** The inferred genetic ancestry labels for the study samples.
- **3D PCA Plot:** A three-dimensional PCA plot (PC1, PC2, PC3) demonstrating the projection of study samples onto the reference PCA space.
- **Confusion Matrix:** Confusion matrices for each classifier used in the pipeline.

## Running the Pipeline

To run the pipeline, please follow these instructions:

1. Ensure you have the required dependencies installed, including TRACE and Nextflow.

2. Clone this repository to your local machine or your account on the remote cluster using the following command:

```bash
git clone https://github.com/CERC-Genomic-Medicine/BQC19_Imputation_Panel.git
```
3. Create a new folder where the pipeline results and log files will be generated.

4. Navigate to the new folder and copy the nextflow.config file from this repository.

5. Edit the nextflow.config file to customize it according to your requirements. Provide the file paths for the imputed and truth VCF files. Please note that this pipeline only supports VCF format.

6. Execute the pipeline using the provided command:

```bash
sbatch --account="name of the account" --time=48:00:00 --mem=4G -J ancestry --wrap="nextflow run /path/to/ancestry.nf" -o ancestry.slurm.log
```

## Dependencies

Ensure you have the following dependencies installed:

- [Nextflow](https://www.nextflow.io/)
- [HDGP+1KG dataset](https://gnomad.broadinstitute.org/news/2020-10-gnomad-v3-1-new-content-methods-annotations-and-data-availability/) 
- [TRACE software](http://csg.sph.umich.edu/chaolong/LASER/)
- [bcftools](https://samtools.github.io/bcftools/howtos/install.html)
- Python pakages: pandas, sklearn, matplotlib, numpy

Acknowledgements
We would like to acknowledge the developers of LASER and TRACE software for providing the tools necessary for genetic ancestry estimation. Their contribution is greatly appreciated.